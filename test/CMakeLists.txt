# Tests

# Add the binary tree directory to the search path for linking and include files
link_directories (${PROJECT_BINARY_DIR}/src)
include_directories (${CMAKE_CURRENT_BINARY_DIR} ${PROJECT_SOURCE_DIR}/include ${PROJECT_BINARY_DIR}/include )

#define macro to simplify adding tests
macro (do_test arg result)
  add_test (${arg} ${TARGET_SYSTEM_EMULATOR} ${arg}${CMAKE_EXECUTABLE_SUFFIX})
  set_tests_properties (${arg}
    PROPERTIES PASS_REGULAR_EXPRESSION ${result}
    )
endmacro ()

if(BUILD_MPIN)
  add_executable (test_mpin test_mpin.c)
  add_executable (test_mpin_sign test_mpin_sign.c)
  add_executable (test_mpin_good test_mpin_good.c)
  add_executable (test_mpin_bad_pin test_mpin_bad_pin.c)
  add_executable (test_mpin_bad_token test_mpin_bad_token.c)
  add_executable (test_mpin_expired_tp test_mpin_expired_tp.c)
  add_executable (test_mpin_tp test_mpin_tp.c)
  add_executable (test_mpin_random test_mpin_random.c)
  add_executable (test_mpinfull test_mpinfull.c)
  add_executable (test_mpinfullSingle test_mpinfullSingle.c)
  add_executable (test_mpinfull_random test_mpinfull_random.c)
  add_executable (test_utils test_utils.c)
  # Link the executable to the libraries
  target_link_libraries (test_mpin mpin) 
  target_link_libraries (test_mpin_sign mpin) 
  target_link_libraries (test_mpin_good mpin) 
  target_link_libraries (test_mpin_bad_pin mpin) 
  target_link_libraries (test_mpin_bad_token mpin) 
  target_link_libraries (test_mpin_expired_tp mpin) 
  target_link_libraries (test_mpin_tp mpin) 
  target_link_libraries (test_mpin_random mpin) 
  target_link_libraries (test_mpinfull mpin) 
  target_link_libraries (test_mpinfullSingle mpin) 
  target_link_libraries (test_mpinfull_random mpin) 
  target_link_libraries (test_utils mpin) 
  # tests
  do_test (test_mpin "SUCCESS Error Code 0")
  do_test (test_mpin_sign "TEST PASSED")
  do_test (test_mpin_good "SUCCESS Error Code 0")
  do_test (test_mpin_bad_pin "FAILURE")
  do_test (test_mpin_bad_token "FAILURE Invalid Token Error Code -19")
  do_test (test_mpin_expired_tp "FAILURE Invalid Token Error Code -19")
  do_test (test_mpin_tp "Iteration ${MPIN_TIME_PERMIT_TESTS} SUCCESS Error Code 0")
  do_test (test_mpin_random "Iteration ${MPIN_RANDOM_TESTS} SUCCESS Error Code 0")
  do_test (test_mpinfull "SUCCESS")
  do_test (test_mpinfullSingle "SUCCESS")
  do_test (test_mpinfull_random "Iteration ${MPIN_RANDOM_TESTS} SUCCESS")
  do_test (test_utils "SUCCESS")
endif(BUILD_MPIN)

if(BUILD_WCC)
  add_executable (test_wcc_gcm test_wcc_gcm.c)
  add_executable (test_wcc test_wcc.c)
  add_executable (test_wcc_random test_wcc_random.c)
  # Link the executable to the libraries
  target_link_libraries (test_wcc_gcm wcc) 
  target_link_libraries (test_wcc wcc) 
  target_link_libraries (test_wcc_random wcc) 
  # tests  
  do_test (test_wcc_gcm "SUCCESS")
  do_test (test_wcc "SUCCESS")
  do_test (test_wcc_random "SUCCESS")
endif(BUILD_WCC)  

if(AMCL_CHOICE STREQUAL "NIST256")
  message(STATUS "Run ${AMCL_CHOICE} ECC Tests")
  add_executable (test_ecdh test_ecdh.c)
  add_executable (test_ecdsa_keypair test_ecdsa_keypair.c)
  add_executable (test_ecdsa_sign test_ecdsa_sign.c)
  add_executable (test_ecdsa_verify test_ecdsa_verify.c)
  # Link the executable to the libraries
  target_link_libraries (test_ecdh ecdh) 
  target_link_libraries (test_ecdsa_keypair ecdh) 
  target_link_libraries (test_ecdsa_sign ecdh) 
  target_link_libraries (test_ecdsa_verify ecdh) 
  # test
  add_test(NAME test_ecdh_NIST256 COMMAND test_ecdh ${PROJECT_SOURCE_DIR}/testVectors/ecdh/P-256/KAS_ECC_CDH_PrimitiveTest.txt)
  set_tests_properties (test_ecdh_NIST256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
  add_test(NAME test_ecdsa_keypair_NIST256 COMMAND test_ecdsa_keypair ${PROJECT_SOURCE_DIR}/testVectors/ecdsa/P-256/KeyPair.rsp)
  set_tests_properties (test_ecdsa_keypair_NIST256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
  add_test(NAME test_ecdsa_sign_NIST256_SHA256 COMMAND test_ecdsa_sign ${PROJECT_SOURCE_DIR}/testVectors/ecdsa/P-256/sha256Sign.rsp sha256)
  set_tests_properties (test_ecdsa_sign_NIST256_SHA256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
  add_test(NAME test_ecdsa_sign_NIST256_SHA512 COMMAND test_ecdsa_sign ${PROJECT_SOURCE_DIR}/testVectors/ecdsa/P-256/sha512Sign.rsp sha512)
  set_tests_properties (test_ecdsa_sign_NIST256_SHA512 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
  add_test(NAME test_ecdsa_verify_NIST256_SHA256 COMMAND test_ecdsa_verify ${PROJECT_SOURCE_DIR}/testVectors/ecdsa/P-256/sha256Verify.rsp sha256)
  set_tests_properties (test_ecdsa_verify_NIST256_SHA256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
  add_test(NAME test_ecdsa_verify_NIST256_SHA512 COMMAND test_ecdsa_verify ${PROJECT_SOURCE_DIR}/testVectors/ecdsa/P-256/sha512Verify.rsp sha512)
  set_tests_properties (test_ecdsa_verify_NIST256_SHA512 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
endif(AMCL_CHOICE STREQUAL "NIST256")

if(AMCL_CHOICE STREQUAL "NIST521")
  message(STATUS "Run ${AMCL_CHOICE} ECC Tests")
  add_executable (test_ecdh test_ecdh.c)
  add_executable (test_ecdsa_keypair test_ecdsa_keypair.c)
  add_executable (test_ecdsa_sign test_ecdsa_sign.c)
  add_executable (test_ecdsa_verify test_ecdsa_verify.c)
  # Link the executable to the libraries
  target_link_libraries (test_ecdh ecdh) 
  target_link_libraries (test_ecdsa_keypair ecdh) 
  target_link_libraries (test_ecdsa_sign ecdh) 
  target_link_libraries (test_ecdsa_verify ecdh) 
  # test
  add_test(NAME test_ecdh_NIST521 COMMAND test_ecdh ${PROJECT_SOURCE_DIR}/testVectors/ecdh/P-521/KAS_ECC_CDH_PrimitiveTest.txt)
  set_tests_properties (test_ecdh_NIST521 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
  add_test(NAME test_ecdsa_keypair_NIST521 COMMAND test_ecdsa_keypair ${PROJECT_SOURCE_DIR}/testVectors/ecdsa/P-521/KeyPair.rsp)
  set_tests_properties (test_ecdsa_keypair_NIST521 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
  add_test(NAME test_ecdsa_sign_NIST521_SHA256 COMMAND test_ecdsa_sign ${PROJECT_SOURCE_DIR}/testVectors/ecdsa/P-521/sha256Sign.rsp sha256)
  set_tests_properties (test_ecdsa_sign_NIST521_SHA256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
  add_test(NAME test_ecdsa_sign_NIST521_SHA512 COMMAND test_ecdsa_sign ${PROJECT_SOURCE_DIR}/testVectors/ecdsa/P-521/sha512Sign.rsp sha512)
  set_tests_properties (test_ecdsa_sign_NIST521_SHA512 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
  add_test(NAME test_ecdsa_verify_NIST521_SHA256 COMMAND test_ecdsa_verify ${PROJECT_SOURCE_DIR}/testVectors/ecdsa/P-521/sha256Verify.rsp sha256)
  set_tests_properties (test_ecdsa_verify_NIST521_SHA256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
  add_test(NAME test_ecdsa_verify_NIST521_SHA512 COMMAND test_ecdsa_verify ${PROJECT_SOURCE_DIR}/testVectors/ecdsa/P-521/sha512Verify.rsp sha512)
  set_tests_properties (test_ecdsa_verify_NIST521_SHA512 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
endif(AMCL_CHOICE STREQUAL "NIST521")

# tests
add_executable (test_rsa test_rsa.c)
add_executable (test_ecc test_ecc.c)
add_executable (test_version test_version.c)
add_executable (test_hash test_hash.c)
add_executable (test_gcm_encrypt test_gcm_encrypt.c)
add_executable (test_gcm_decrypt test_gcm_decrypt.c)
add_executable (test_aes_encrypt test_aes_encrypt.c)
add_executable (test_aes_decrypt test_aes_decrypt.c)
# Link the executable to the libraries
target_link_libraries (test_rsa rsa) 
target_link_libraries (test_ecc ecdh) 
target_link_libraries (test_version amcl) 
target_link_libraries (test_hash amcl) 
target_link_libraries (test_gcm_encrypt amcl) 
target_link_libraries (test_gcm_decrypt  amcl) 
target_link_libraries (test_aes_encrypt amcl) 
target_link_libraries (test_aes_decrypt  amcl) 

# smoke tests  
do_test (test_rsa "SUCCESS")
do_test (test_ecc "SUCCESS")
do_test (test_version "Version: ${AMCL_VERSION_MAJOR}.${AMCL_VERSION_MINOR}.${AMCL_VERSION_PATCH}")

# hash tests
add_test(NAME test_hash_256 COMMAND test_hash ${PROJECT_SOURCE_DIR}/testVectors/sha/256/SHA256ShortMsg.rsp sha256)
set_tests_properties (test_hash_256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_hash_512 COMMAND test_hash ${PROJECT_SOURCE_DIR}/testVectors/sha/512/SHA512ShortMsg.rsp sha512)
set_tests_properties (test_hash_512 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)

# AES-GCM tests
add_test(NAME test_gcm_encrypt_128 COMMAND test_gcm_encrypt ${PROJECT_SOURCE_DIR}/testVectors/gcm/gcmEncryptExtIV128.rsp)
set_tests_properties (test_gcm_encrypt_128 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_gcm_encrypt_256 COMMAND test_gcm_encrypt ${PROJECT_SOURCE_DIR}/testVectors/gcm/gcmEncryptExtIV256.rsp)
set_tests_properties (test_gcm_encrypt_256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_gcm_decrypt_128 COMMAND test_gcm_decrypt ${PROJECT_SOURCE_DIR}/testVectors/gcm/gcmDecrypt128.rsp)
set_tests_properties (test_gcm_decrypt_128 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_gcm_decrypt_256 COMMAND test_gcm_decrypt ${PROJECT_SOURCE_DIR}/testVectors/gcm/gcmDecrypt256.rsp)
set_tests_properties (test_gcm_decrypt_256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)

# AES tests
add_test(NAME test_aes_encrypt_ECB_128 COMMAND test_aes_encrypt ${PROJECT_SOURCE_DIR}/testVectors/aes/ECBMMT128.rsp  ECB)
set_tests_properties (test_aes_encrypt_ECB_128 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_aes_encrypt_ECB_256 COMMAND test_aes_encrypt ${PROJECT_SOURCE_DIR}/testVectors/aes/ECBMMT256.rsp  ECB)
set_tests_properties (test_aes_encrypt_ECB_256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_aes_encrypt_CBC_128 COMMAND test_aes_encrypt ${PROJECT_SOURCE_DIR}/testVectors/aes/CBCMMT128.rsp  CBC)
set_tests_properties (test_aes_encrypt_CBC_128 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_aes_encrypt_CBC_256 COMMAND test_aes_encrypt ${PROJECT_SOURCE_DIR}/testVectors/aes/CBCMMT256.rsp  CBC)
set_tests_properties (test_aes_encrypt_CBC_256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_aes_encrypt_CTR_128 COMMAND test_aes_encrypt ${PROJECT_SOURCE_DIR}/testVectors/aes/amcl_CTRMCL128.rsp  CTR)
set_tests_properties (test_aes_encrypt_CTR_128 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_aes_encrypt_CTR_256 COMMAND test_aes_encrypt ${PROJECT_SOURCE_DIR}/testVectors/aes/amcl_CTRMCL256.rsp  CTR)
set_tests_properties (test_aes_encrypt_CTR_256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)

add_test(NAME test_aes_decrypt_ECB_128 COMMAND test_aes_decrypt ${PROJECT_SOURCE_DIR}/testVectors/aes/ECBMMT128.rsp  ECB)
set_tests_properties (test_aes_decrypt_ECB_128 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_aes_decrypt_ECB_256 COMMAND test_aes_decrypt ${PROJECT_SOURCE_DIR}/testVectors/aes/ECBMMT256.rsp  ECB)
set_tests_properties (test_aes_decrypt_ECB_256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_aes_decrypt_CBC_128 COMMAND test_aes_decrypt ${PROJECT_SOURCE_DIR}/testVectors/aes/CBCMMT128.rsp  CBC)
set_tests_properties (test_aes_decrypt_CBC_128 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_aes_decrypt_CBC_256 COMMAND test_aes_decrypt ${PROJECT_SOURCE_DIR}/testVectors/aes/CBCMMT256.rsp  CBC)
set_tests_properties (test_aes_decrypt_CBC_256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_aes_decrypt_CTR_128 COMMAND test_aes_decrypt ${PROJECT_SOURCE_DIR}/testVectors/aes/amcl_CTRMCL128.rsp  CTR)
set_tests_properties (test_aes_decrypt_CTR_128 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
add_test(NAME test_aes_decrypt_CTR_256 COMMAND test_aes_decrypt ${PROJECT_SOURCE_DIR}/testVectors/aes/amcl_CTRMCL256.rsp  CTR)
set_tests_properties (test_aes_decrypt_CTR_256 PROPERTIES PASS_REGULAR_EXPRESSION SUCCESS)
